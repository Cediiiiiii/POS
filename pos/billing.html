<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f4f4f9;
        }
        .container {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .sections {
            display: flex;
            flex-direction: row;
            flex: 1;
            overflow: hidden;
        }
        .section {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            border-right: 1px solid #ddd;
        }
        .section:last-child {
            border-right: none;
        }
        h2 {
            text-align: center;
            margin-bottom: 10px;
        }
        .category {
            padding: 10px;
            background-color: #e1e4ea;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
        }
        .category:hover {
            background-color: #c5c8cf;
        }
        .card {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            cursor: pointer;
            flex: 1 0 calc(33.333% - 20px);
            box-sizing: border-box;
        }
        .card img {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
        }
        .cards-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .bill {
            padding: 10px;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .bill-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }
        .bill-item .remove {
            margin-left: 10px;
            color: red;
            cursor: pointer;
        }
        .return-button, .checkout-button, .insert-button {
            display: block;
            margin: 10px auto;
            padding: 10px;
            text-align: center;
            border: none;
            background-color: #5cb85c;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        .return-button:hover, .checkout-button:hover, .insert-button:hover {
            background-color: #4cae4c;
        }
        .logout-button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: #d9534f;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .logout-button:hover {
            background-color: #c9302c;
        }

        @media (max-width: 768px) {
            .sections {
                flex-direction: column;
            }
            .section {
                border-right: none;
                border-bottom: 1px solid #ddd;
            }
            .section:last-child {
                border-bottom: none;
            }
            .card {
                flex: 1 0 calc(50% - 20px);
            }
        }

        @media (max-width: 480px) {
            .card {
                flex: 1 0 calc(100% - 20px);
            }
        }
    </style>
</head>
<body>
    <button class="logout-button" onclick="logout()">Logout</button>

    <div class="container">
        <div class="sections">
            <div class="section" id="categories">
                <h2>Categories</h2>
                <button class="return-button" id="returnButton" style="display: none;">Return to All Items</button>
            </div>
            <div class="section" id="items">
                <h2>Items</h2>
                <div class="cards-container" id="itemsContainer"></div>
            </div>
            <div class="section" id="bill">
                <h2>Bill</h2>
                <div class="bill" id="billContent"></div>
                <button class="checkout-button" id="checkoutButton">Checkout</button>
                <button class="insert-button" onclick="window.location.href='add.html';">Go to Insert Data</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function logout() {
            if (confirm("Are you sure you want to log out?")) {
                window.location.href = "logout.php"; // Redirect to the logout script
            }
        }
        
        $(document).ready(function() {
            function fetchCategories() {
                $.ajax({
                    url: 'fetch_categories.php',
                    type: 'GET',
                    success: function(categories) {
                        categories.forEach(category => {
                            $('#categories').append(
                                `<div class="category" data-category="${category}">${category}</div>`
                            );
                        });
                    }
                });
            }

            function fetchItems(category = null) {
    const params = category ? { category } : {};
    $.ajax({
        url: 'fetch_items.php',
        type: 'GET',
        data: params,
        success: function(items) {
            $('#itemsContainer').empty();
            if (category) {
                $('#returnButton').show();
            } else {
                $('#returnButton').hide();
            }
            items.forEach(item => {
                $('#itemsContainer').append(
                    `<div class="card" data-id="${item.id}" data-name="${item.name}" data-price="${item.price}">
                        <img src="${item.image_path}" alt="${item.name}">
                        <p>${item.name}</p>
                        <p>$${item.price}</p>
                        <button class="delete-item" style="background-color: red; color: white; border: none; padding: 5px 10px; cursor: pointer;">Delete</button>
                    </div>`
                );
            });
        }
    });
}
            function addItemToBill(item) {
                const billContent = $('#billContent');
                const itemRow = `<div class="bill-item" data-id="${item.id}">
                                    <span>${item.name}</span>
                                    <span>$${item.price}</span>
                                    <span class="remove">&times;</span>
                                 </div>`;
                billContent.append(itemRow);
            }

            function printReceipt() {
                const billContent = $('#billContent').html();
                const newWindow = window.open('', '', 'width=400,height=600');
                newWindow.document.write('<h2>Receipt</h2>' + billContent);
                newWindow.document.close();
                newWindow.print();
            }

            $(document).on('click', '.category', function() {
                const category = $(this).data('category');
                fetchItems(category);
            });

            $(document).on('click', '.card', function() {
                const item = {
                    id: $(this).data('id'),
                    name: $(this).data('name'),
                    price: $(this).data('price')
                };
                addItemToBill(item);
            });

            $(document).on('click', '.remove', function() {
                $(this).closest('.bill-item').remove();
            });

            $(document).on('click', '.delete-item', function(event) {
    event.stopPropagation(); // Prevent triggering the parent .card click event
    const itemId = $(this).closest('.card').data('id'); // Get the item ID from the card

    if (confirm('Are you sure you want to delete this item?')) {
        $.ajax({
            url: 'delete_from_stock.php', // Path to the PHP script
            type: 'POST',
            data: { id: itemId },
            success: function(response) {
                try {
                    const result = JSON.parse(response); // Parse the JSON response

                    if (result.status === 'success') {
                        alert(result.message);

                        // Remove the item card from the UI
                        $(`[data-id="${itemId}"]`).remove();

                        // Reset all data-id attributes for remaining cards
                        $('.card').each(function(index) {
                            $(this).attr('data-id', index + 1);
                        });
                    } else {
                        alert(result.message);
                    }
                } catch (e) {
                    alert('Unexpected response from server.');
                    console.error('Error parsing response:', e, 'Response:', response);
                }
            },
            error: function(xhr, status, error) {
                alert('Failed to communicate with the server. Please try again.');
                console.error('AJAX error:', xhr, status, error);
            }
        });
    }
});

             
            $('#returnButton').on('click', function() {
                fetchItems();
            });

            $('#checkoutButton').on('click', function() {
                printReceipt();
            });

            // Initial load
            fetchCategories();
            fetchItems();
        });
    </script>
</body>
</html>
